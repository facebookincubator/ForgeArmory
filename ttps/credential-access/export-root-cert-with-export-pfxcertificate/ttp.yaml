# Converted from Atomic Red Team - Unsecured Credentials: Private Keys
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1552.004
# Original auto_generated_guid: 7617f689-bbd8-44bc-adcd-6f8968897848

---
api_version: 2.0
uuid: 79731b06-e7cc-4356-a35f-0c8681d6a0ad
name: Export Root Certificate with Export-PFXCertificate
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  Creates a Root certificate and exports it with Export-PFXCertificate PowerShell Cmdlet.
  Upon a successful attempt, this will write a pfx to disk and utilize the Cmdlet Export-PFXCertificate.

mitre:
  tactics:
    - "TA0006 Credential Access"
  techniques:
    - "T1552 Unsecured Credentials"
  subtechniques:
    - "T1552.004 Private Keys"

requirements:
  platforms:
    - os: windows
  superuser: true

args:
  - name: pfx_path
    description: output path of the certificate
    type: string
    default: "C:\\Users\\Public\\atomicredteam.pfx"

steps:
  - name: create_and_export_certificate
    executor: powershell
    inline: |
      $mypwd = ConvertTo-SecureString -String "AtomicRedTeam" -Force -AsPlainText
      $cert = New-SelfSignedCertificate -DnsName atomicredteam.com -CertStoreLocation cert:\LocalMachine\My
      Set-Location Cert:\LocalMachine\My
      Get-ChildItem -Path $cert.Thumbprint | Export-PfxCertificate -FilePath {{.Args.pfx_path}} -Password $mypwd
    cleanup:
      executor: powershell
      inline: |
        try {
          $cert = Import-Certificate -FilePath {{.Args.pfx_path}} -CertStoreLocation Cert:\LocalMachine\My
          Get-ChildItem Cert:\LocalMachine\My\$($cert.Thumbprint) -ErrorAction Ignore | Remove-Item -ErrorAction Ignore
          Get-ChildItem Cert:\LocalMachine\Root\$($cert.Thumbprint) -ErrorAction Ignore | Remove-Item -ErrorAction Ignore
        } catch { }
