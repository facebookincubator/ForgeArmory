# Converted from Atomic Red Team - Unsecured Credentials: Private Keys
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1552.004
# Original auto_generated_guid: 78b274f8-acb0-428b-b1f7-7b0d0e73330a

---
api_version: 2.0
uuid: 8c8fa363-eb6f-4528-8982-5c2be56b7d11
name: Export Root Certificate with Export-Certificate
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  Creates a Root certificate and exports it with Export-Certificate PowerShell Cmdlet.
  Upon a successful attempt, this will write a pfx to disk and utilize the Cmdlet Export-Certificate.

mitre:
  tactics:
    - "TA0006 Credential Access"
  techniques:
    - "T1552 Unsecured Credentials"
  subtechniques:
    - "T1552.004 Private Keys"

requirements:
  platforms:
    - os: windows
  superuser: true

args:
  - name: pfx_path
    description: Path of the certificate
    type: path
    default: "C:\\Users\\Public\\AtomicRedTeam.cer"

steps:
  - name: create_and_export_certificate
    executor: powershell
    inline: |
      $cert = New-SelfSignedCertificate -DnsName atomicredteam.com -CertStoreLocation cert:\LocalMachine\My
      Set-Location Cert:\LocalMachine\My
      Export-Certificate -Type CERT -Cert  Cert:\LocalMachine\My\$($cert.Thumbprint) -FilePath {{.Args.pfx_path}}
    cleanup:
      executor: powershell
      inline: |
        try {
           $cert = Import-Certificate -FilePath {{.Args.pfx_path}} -CertStoreLocation Cert:\LocalMachine\My -ErrorAction Ignore
           Get-ChildItem Cert:\LocalMachine\My\$($cert.Thumbprint) -ErrorAction Ignore | Remove-Item -ErrorAction Ignore
           Get-ChildItem Cert:\LocalMachine\Root\$($cert.Thumbprint) -ErrorAction Ignore | Remove-Item -ErrorAction Ignore
        }
        catch { }
