---
name: Launch Agent
description: |
  This TTP creates a launch agent which executes a shell script to run a command.
  If no command_or_path is supplemented, it will run calc by default.
args:
  - name: cleanup
    default: true
  - name: command_or_path
    default: /Users/Shared/calc.sh
mitre:
  tactics:
    - T0003 Persistence
  techniques:
    - T1543 Create or Modify System Process
  subtechniques:
    - T1543.001 Create or Modify System Process: Launch Agent
steps:
  - name: launchagent
    inline: |
      set -e

      echo -e "First building the source Swift into a compiled binary..."
      swiftc launchagent.swift -o launchagent
      echo "Next, executing the compiled launchagent binary. This will drop the script at the specified path and then dropping ~/Library/LaunchAgents/com.ttpforge.plist to call the script and immediately loading it with launchctl..."
      ./launchagent "{{ .Args.command_or_path }}"
      echo "TTP Done!"
    cleanup:
      inline: |
        echo "Sleeping for 15 seconds and then removing the mechanism..."
        sleep 15
        launchctl unload -w ~/Library/LaunchAgents/com.ttpforge.plist
        rm -f "{{ .Args.command_or_path }}"
        rm -f ~/Library/LaunchAgents/com.ttpforge.plist
        rm -f launchagent
        echo "Cleanup Finished!"
