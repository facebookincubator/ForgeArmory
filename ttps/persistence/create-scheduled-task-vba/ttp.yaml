# Converted from Atomic Red Team - Scheduled Task/Job: Scheduled Task
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1053.005
# Original auto_generated_guid: ecd3fa21-7792-41a2-8726-2c5c673414d3

---
api_version: 2.0
uuid: dfb9eefc-208f-49dc-b47e-e52b3f821a0a
name: Task Scheduler via VBA
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  This module utilizes the Windows API to schedule a task for code execution (notepad.exe). The task scheduler will execute "notepad.exe" within
  30 - 40 seconds after this module has run

mitre:
  tactics:
    - "TA0003 Persistence"
    - "TA0004 Privilege Escalation"
  techniques:
    - "T1053 Scheduled Task/Job"
  subtechniques:
    - "T1053.005 Scheduled Task"

requirements:
  platforms:
    - os: windows
  superuser: false

args:
  - name: ms_product
    description: Maldoc application Word
    type: string
    default: "Word"
  - name: macro_file_path
    description: Path to macro code file
    type: path
    default: "./T1053.005-macrocode.txt"
  - name: invoke_maldoc_path
    description: Path to Invoke-MalDoc.ps1 script
    type: path
    default: "./Invoke-MalDoc.ps1"

steps:
  - name: ensure_ms_office_installed
    executor: powershell
    inline: |
      try {
        New-Object -COMObject "{{.Args.ms_product}}.Application" | Out-Null
        $process = "{{.Args.ms_product}}"; if ( $process -eq "Word") {$process = "winword"}
        Stop-Process -Name $process -ErrorAction SilentlyContinue
        exit 0
      } catch {
        Write-Error "Microsoft {{.Args.ms_product}} must be installed. Exiting..."
        exit 1
      }

  - name: ensure_invoke_maldoc_exists
    executor: powershell
    inline: |
      if (-not (Test-Path "{{.Args.invoke_maldoc_path}}")) {
        Write-Error "Invoke-MalDoc.ps1 not found at {{.Args.invoke_maldoc_path}}. Exiting..."
        exit 1
      }

  - name: ensure_macro_file_exists
    executor: powershell
    inline: |
      if (-not (Test-Path "{{.Args.macro_file_path}}")) {
        Write-Error "Macro file not found at {{.Args.macro_file_path}}. Exiting..."
        exit 1
      }

  - name: execute_task_scheduler_via_vba
    executor: powershell
    inline: |
      . "{{.Args.invoke_maldoc_path}}"
      Invoke-MalDoc -macroFile "{{.Args.macro_file_path}}" -officeProduct "{{.Args.ms_product}}" -sub "Scheduler"
    cleanup:
      executor: powershell
      inline: |
        Unregister-ScheduledTask -TaskName "Run Notepad" -Confirm:$false
