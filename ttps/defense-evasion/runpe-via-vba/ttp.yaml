# Converted from Atomic Red Team - Process Injection: Process Hollowing
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1055.012
# Original auto_generated_guid: 3ad4a037-1598-4136-837c-4027e4fa319b

---
api_version: 2.0
uuid: 0b9e55d0-9395-4cdb-9713-adc548d9e5bd
name: RunPE via VBA
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  This module executes notepad.exe from within the WINWORD.EXE process using VBA macros.

mitre:
  tactics:
    - "TA0004 Privilege Escalation"
    - "TA0005 Defense Evasion"
  techniques:
    - "T1055 Process Injection"
  subtechniques:
    - "T1055.012 Process Hollowing"

requirements:
  platforms:
    - os: windows
  superuser: false

args:
  - name: ms_product
    description: Maldoc application (Word)
    type: string
    default: "Word"
  - name: macro_file_path
    description: Path to macro code file
    type: path
    default: "./T1055.012-macrocode.txt"
  - name: invoke_maldoc_path
    description: Path to Invoke-MalDoc.ps1 script
    type: path
    default: "./Invoke-MalDoc.ps1"

steps:
  - name: check_microsoft_office
    executor: powershell
    inline: |
      try {
        New-Object -COMObject "{{.Args.ms_product}}.Application" | Out-Null
        $process = "{{.Args.ms_product}}"; if ( $process -eq "Word") {$process = "winword"}
        Stop-Process -Name $process -ErrorAction SilentlyContinue
        exit 0
      } catch {
        Write-Error "Microsoft {{.Args.ms_product}} is not installed. Please install it to run this test."
        exit 1
      }

  - name: ensure_invoke_maldoc_exists
    executor: powershell
    inline: |
      if (-not (Test-Path "{{.Args.invoke_maldoc_path}}")) {
        Write-Error "Invoke-MalDoc.ps1 not found at {{.Args.invoke_maldoc_path}}. Exiting..."
        exit 1
      }

  - name: ensure_macro_file_exists
    executor: powershell
    inline: |
      if (-not (Test-Path "{{.Args.macro_file_path}}")) {
        Write-Error "Macro file not found at {{.Args.macro_file_path}}. Exiting..."
        exit 1
      }

  - name: execute_runpe_via_vba
    executor: powershell
    inline: |
      . "{{.Args.invoke_maldoc_path}}"
      Invoke-MalDoc -macroFile "{{.Args.macro_file_path}}" -officeProduct "{{.Args.ms_product}}" -sub "Exploit"
