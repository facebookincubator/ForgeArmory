# Converted from Atomic Red Team - Subvert Trust Controls: Install Root Certificate
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1553.004
# Original auto_generated_guid: 76f49d86-5eb1-461a-a032-a480f86652f1

---
api_version: 2.0
uuid: 53ed8462-748c-48e6-9b32-b177b4bc43f4
name: Install root CA on Windows
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  Creates a root CA with Powershell

mitre:
  tactics:
    - "TA0005 Defense Evasion"
  techniques:
    - "T1553 Subvert Trust Controls"
  subtechniques:
    - "T1553.004 Install Root Certificate"

requirements:
  platforms:
    - os: windows
  superuser: true

args:
  - name: pfx_path
    description: Path of the certificate
    type: path
    default: "C:\\Users\\Public\\rootCA.cer"

steps:
  - name: ensure_certificate_exists
    executor: powershell
    inline: |
      if (-not (Test-Path {{.Args.pfx_path}})) {
        $cert = New-SelfSignedCertificate -DnsName atomicredteam.com -CertStoreLocation cert:\LocalMachine\My
        Export-Certificate -Type CERT -Cert  Cert:\LocalMachine\My\$($cert.Thumbprint) -FilePath {{.Args.pfx_path}}
      }
    cleanup:
      executor: powershell
      inline: |
        Remove-Item {{.Args.pfx_path}} -ErrorAction Ignore

  - name: install_root_ca
    executor: powershell
    inline: |
      $cert = Import-Certificate -FilePath {{.Args.pfx_path}} -CertStoreLocation Cert:\LocalMachine\My
      Move-Item -Path $cert.PSPath -Destination "Cert:\LocalMachine\Root"
    cleanup:
      executor: powershell
      inline: |
        try {
           $cert = Import-Certificate -FilePath {{.Args.pfx_path}} -CertStoreLocation Cert:\LocalMachine\My -ErrorAction Ignore
           Get-ChildItem Cert:\LocalMachine\My\$($cert.Thumbprint) -ErrorAction Ignore | Remove-Item -ErrorAction Ignore
           Get-ChildItem Cert:\LocalMachine\Root\$($cert.Thumbprint) -ErrorAction Ignore | Remove-Item -ErrorAction Ignore
        }
        catch { }
